# DAT (Dynamic Alpha Tuning) Paper Replication
# Replicates the DAT method from the paper that combines BM25 and Dense retrieval
# with adaptive weights computed via LLM judge.

experiment:
  name: dat_paper_replication
  output_dir: "./outputs/experiments/dat_replication"

dataset:
  name: "scifact"
  root: "./data/scifact/processed/beir"
  split_preference: ["test", "dev", "validation", "train"]

retrievers:
  # DAT Hybrid Retriever (adaptive alpha via LLM judge)
  - name: "dat_hybrid"
    type: "dat_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null  # FlatIP
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      llm_judge:
        model: "gpt-4o-mini"
        temperature: 0.0
        max_tokens: 10
        # prompt_template will be provided later from paper appendix
        cache_dir: "./outputs/artifacts/llm_judge_cache"
        timeout: 30
        max_retries: 3
        max_text_tokens: 2000
        rate_limit_tier: 2  # Tier 2: 10,000 RPM, 1,000,000 TPM
        rate_limit_safety_margin: 0.1  # Wait when 90% of limit is used

  # Baseline Hybrid Retrievers with fixed alpha (grid search)
  - name: "baseline_alpha_0.0"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.0  # BM25 only

  - name: "baseline_alpha_0.1"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.1

  - name: "baseline_alpha_0.2"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.2

  - name: "baseline_alpha_0.3"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.3

  - name: "baseline_alpha_0.4"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.4

  - name: "baseline_alpha_0.5"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.5

  - name: "baseline_alpha_0.6"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.6  # Paper mentions this as optimal

  - name: "baseline_alpha_0.7"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.7

  - name: "baseline_alpha_0.8"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.8

  - name: "baseline_alpha_0.9"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 0.9

  - name: "baseline_alpha_1.0"
    type: "baseline_hybrid"
    bm25:
      k1: 0.9
      b: 0.4
    dense:
      semantic:
        model: "text-embedding-3-large"
        provider: "openai"
      index:
        type: "faiss"
        factory: null
        metric: "ip"
        artifact_dir: "./outputs/artifacts/scifact_dat_dense"
        index_name: "dense.index"
    fusion:
      top_k: 20
      alpha: 1.0  # Dense only

metrics:
  - "nDCG"
  - "MRR"
  - "MAP"
  - "Recall"
  - "Precision"

ks: [1, 3, 5, 10, 20]  # Include 20 for MRR@20 as in paper

output_formats:
  - "csv"
  - "json"

